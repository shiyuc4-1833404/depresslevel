```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```
# Results
```{r,echo=FALSE}
# Deal with Caffeine and Depression dataset
library(ggridges)
library(dplyr)
library(haven)
library(ggplot2)
library(readr)
# data <- read_xpt("/Users/angelina/Documents/CU/23FALL/5702/Final Project/P_DR1IFF.XPT")
data <- read_xpt("/Users/shiyun/Desktop/P_DR1IFF.XPT")
depress <- read_xpt("P_DPQ.XPT")
data2 <- dplyr::select(data, SEQN, DR1ICAFF)
data2 <- data2 |>
  group_by(SEQN) |>
  dplyr::summarise(CaffConsump = sum(DR1ICAFF))
merged_data <- merge(data2, depress, by = "SEQN", all = TRUE)
columns <- colnames(merged_data)[1:11]
merged_data <- dplyr::select(merged_data, columns)
merged_data <- na.omit(merged_data)
for (i in columns) {
  merged_data[[i]][merged_data[[i]] == 7] <- 0
  merged_data[[i]][merged_data[[i]] == 9] <- 0
}
merged_data$depressScore <- rowSums(merged_data[, 3:ncol(merged_data)])
merged_data$depressLevel <- merged_data$depressScore
merged_data <- merged_data |>
  mutate(depressLevel = case_when(
    depressLevel >= 0 & depressLevel <= 5 ~ "remission",
    depressLevel > 5 & depressLevel <= 10 ~ "mild",
    depressLevel > 10 & depressLevel <= 15 ~ "moderate",
    depressLevel > 15 & depressLevel <= 20 ~ "moderately severe",
    depressLevel > 20 ~ "severe",
    TRUE ~ as.character(depressLevel)))
```

```{r,echo=FALSE}
# Deal with Demo dataset
info <- read_xpt("P_DEMO.XPT")
oldname <- c("RIAGENDR", "RIDAGEYR", "RIDRETH3", "INDFMPIR", "DMDMARTZ")
newname <- c("Gender", "Age", "Race", "Income", "maritalStatus")
info <- dplyr::select(info, SEQN, RIAGENDR, RIDAGEYR, RIDRETH3,
                      INDFMPIR, DMDMARTZ)
merged_info <- merge(merged_data, info, by = "SEQN", all = TRUE)
merged_info <- na.omit(merged_info)
for (i in 1:5) {
  names(merged_info)[names(merged_info) == oldname[i]] <- newname[i]
}
merged_info <- merged_info |>
  mutate(Gender = case_when(
    Gender == 1 ~ "Male",
    Gender == 2 ~ "Female",
    TRUE ~ as.character(Gender)))

merged_info <- merged_info |>
  mutate(Race = case_when(
    Race == 1 | Race == 2 ~ "Hispanic",
    Race == 3 ~ "White",
    Race == 4 ~ "Black",
    Race == 6 ~ "Asian",
    Race == 7 ~ "Other",
    TRUE ~ as.character(Race)))

merged_info <- merged_info |>
  mutate(maritalStatus = case_when(
    maritalStatus == 1 ~ "Married",
    maritalStatus == 2 ~ "Widowed",
    maritalStatus == 3 ~ "Divorced",
    TRUE ~ as.character(maritalStatus)))
```

## Plot7  
```{r}
library("ggpubr")
high <- ggplot(data=merged_info,aes(x = CaffConsump)) +
  geom_histogram() +
  xlim(200, 800) +
  ylim(0,200) +
  ggtitle("Histogram of Caffine Consumption Lower Part") +
  xlab("Caffine Consumption(mg)")
low <- ggplot(data=merged_info,aes(x = CaffConsump)) +
  geom_histogram() +
  xlim(800, max(merged_info$CaffConsump)) +
  ylim(0,20) +
  ggtitle("Histogram of Caffine Consumption Higher Part") +
  xlab("Caffine Consumption(mg)")
ggarrange(high, low, ncol = 1, nrow = 2)
```
First, let's look at how much caffeine people in the study drink each day, measured in milligrams. We've split the chart into two parts to make it easier to see what's going on. In the first chart, most people fall into the 200 to 400 milligram range. Then, the numbers spread out more evenly up to 600 milligrams. It's important to note that the two charts use different scales on the vertical axis, which helps us understand both the lower and higher caffeine consumption levels. The lower levels have more people, while the higher levels have fewer. Also, in the first chart, the bars are all next to each other without any gaps, showing a continuous range of caffeine amounts. In the second chart, there are some gaps between the bars. This tells us that most people in the study have a caffeine intake of 200 to 800 milligrams a day, but a smaller group consumes a lot more, between 1000 to 4000 milligrams.  

## Plot1
```{r}
library(GGally) 

scatter_custom <- function(data, mapping, ...) {
  ggplot(data = data, mapping = mapping) +
    geom_point(size = 0.5, alpha = 0.3) + 
    theme_minimal()
}

ggpairs(merged_info, 
        columns = c(12, 2, 15, 17), 
        title = "Scatter Plot Matrix for Dataset",
        upper = list(continuous = wrap("cor", size = 4)),
        lower = list(continuous = wrap(scatter_custom))
)
```
Let's dive into how people's depression levels are connected to their age, income, and how much caffeine they drink. First, I'll explain how we measure depression. Every person in our study answered 9 questions about how they've been feeling in the last two weeks. Each question tries to find out how often they've felt symptoms of depression, like feeling down or losing interest in things. They can answer with 'not at all,' 'several days,' 'more than half the days,' or 'nearly every day,' and these answers get points from 0 to 3. Then, we add up all the points from these questions. The total score can be between 0 and 27 - where 0 means no signs of depression, and 27 means very severe depression. Now, change our focus to the top row of the above graph. What we find is that income, especially when compared to the poverty line, has the strongest link to depression scores. This suggests that wealthier people often have lower depression scores. On the other hand, a person's age and the amount of caffeine they consume don't seem to have a strong relationship with their depression score.  

## Plot4
```{r}
ggplot(merged_info) +
  geom_hex(aes(x = CaffConsump, y = depressScore), bins = 10) +
  labs(
    title = "Square Heatmap of Bin Counts",
    x = "Caffeine Consumption",
    y = "depressScore")
```
From the chart we looked at, it seems like there doens't have an association between how much caffeine people drink and their levels of depression. When people consume a lot of caffeine, like between 2000-4000 mg, they mostly have low depression scores, but this could be because there aren't many people in the study who drink that much caffeine. When we look at those who drink less caffeine, which is where most of the study's data is, the depression scores vary quite a bit. In particular, if you look at the lower left part of the chart, you'll notice that many people who don't drink much caffeine also report lower levels of depression.  
## Plot2
```{r}
ggplot(merged_info, aes(Income)) +
  geom_histogram(aes(y=after_stat(density)), color = "blue", 
                 fill = "cornflowerblue", alpha = 0.5) +
  geom_density(lwd=1.25) +
  labs(title = "I/P Ratio Distribution",
       x = "Ratio of family income to poverty", y = "Density") +
  theme_minimal()
```

## Plot3
```{r}
ggplot(merged_info, aes(x=Income, y=depressLevel, fill = depressLevel)) + 
  geom_density_ridges(scale=0.75) +
  geom_boxplot(width = 0.3, alpha = 0.7) +
  theme(legend.position = "none") +
  labs(title="I/P Ratio horizontal boxplots and ridgeline plots vs. Depression Level",
       x="I/P Ratio", y = "Depression Level")
```

## Plot5
```{r}
library(forcats)
ggplot(merged_info, aes(x=fct_infreq(Race), fill = Gender)) + 
  geom_bar() +
  ylab("Count") +
  xlab("Race") +
  ggtitle("Frequency of Race by Gender")
```
Let's check out the race and gender of the people who answered our survey. We grouped races into five categories: White, Black, Hispanic, Asian, and Other. The 'Other' category includes people who identify with more than one race. Most of our survey participants are White, followed by Black, then Hispanic, and the smallest group is Asian. We can also note that within each racial group, the number of females and males is pretty much even, almost like a 50-50 split.

## Plot6
```{r}
library(vcd)
library(vcdExtra)
library(RColorBrewer)
library(MASS)
df <- subset(merged_info, Race %in% c("Asian", 
                                      "Black",
                                      "Hispanic",
                                      "White"))
mosaic(~depressLevel + Gender + Race,
       labeling=vcd::labeling_border(rot_labels = c(0, 0, 30, 0),
                                  labeling_args = list(cex = 1)),
       main="Mosaic Plot of Gender, Race and Depression Level",
       data=df, direction=c("h","v","v"),
       spacing = spacing_dimequal(c(.4, .4, 0)),
       rot_labels = 0,
       highlighting = "depressLevel",
       highlighting_fill = c("#EFF3FF", "#BDD7E7", "#6BAED6", "#3182BD", "#08519C"))
```

## Plot8
```{r}
library(GGally)
ggparcoord(data = merged_info, columns = c(12,15),alphaLines = 0.01) + ggtitle('Parallel Coordinates Plot')
```
